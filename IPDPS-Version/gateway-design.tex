\section{Handling Blockchain Ledger Reorganization}
Without loss of generality, for the discussion of this section, we assume that the storage integration gateway connects with a single peer in the blockchain network.  

When a blockchain ledger reorganization (blockchain reorg in short) replaces the peer's ledger the gateway is connected with, the protocol for blockchain updates ensures that the new ledger the peer has accepted is longer than the old ledger. Now, the new ledger may have all or some the same transactions affecting access control decisions and upload/download protocol executions -- albeit may be in different blocks; or it may have none of those transactions. So the gateway first need to assess to what extent it has been affected by a blockchain reorg then takes necessary corrective actions.

To facilitate detection of the extent of a blockchain reorg, the gateway maintains a sequence of block-hashes starting from the genesis block and ending at what the gateway believes to be the last mined block in the canonical longest chain\footnote{Note that a block's hash uniquely identifies the block in the blockchain.}. Whenever it receives a notification of a new block being added in the existing chain of its connected peer, the gateway extends the block-hash sequence with the new block's hash. The gateway easily identifies that a blockchain reorg has happened in the peer when it detects that the new block being reported from the peer has a different parent hash then the head of its own block-hash sequence. In that case, the gateway continues to request blocks from the peer in the reverse order until a hash matching an entry in its block-hash sequence is found. Then the top non-matching subsequence of block-hashes represents the extent of the blockchain reorg. The gateway then removes this subsequence from its block-hash sequence and starts reorg processing. The gateway's after-reorg corrective actions for access control database updates differ from that for its upload/download protocol execution steps restoration.

\subsection{Correcting the Access Control Database}              
The gateway has a simple strategy for updating its access control database after a blockchain reorg. It has each database record tagged with the hash of the block that causes the record's creation or its latest update, and it maintains older versions of its mutable records in deleted status in the database. Then when the block-hash subsequence for reversed blocks has been received, it deletes all records (active/deleted) that have a matching tag in the subsequence. Then it makes the latest remaining deleted records of mutable records active. 

The gateway database now reflects an earlier state of the current blockchain ledger of its connected peer. As if the gateway was sleeping and unaware of any subsequent block mining. The gateway then continuously asks the peer for newer blocks and keeps processing the events from their audit log. When there is no more blocks to process, the gateway database is consistent with the current blockchain ledger of the peer.

\subsection{Restoring Protocol Execution Steps}
In Ethereum-like blockchains,  out of order transactions from a single blockchain address cannot exist in any blockchain ledger. However, since both document upload and download protocols involve blockchain transactions from both the gateway and the user, it is possible that after a blockchain reorg, the new ledger of the connected peer has some of the user's transactions but none of the gateway's. If this happens then the blockchain information regarding a protocol execution will become inconsistent, consequently, disputable.

To avoid such inconsistency, a document bearer smart contract maintains a simple linear state machine for each ongoing protocol session with a user. The state machine ensures that at the $i^{th}$ state of the contract, only the transaction for the $i+1$ protocol step is accepted in the blockchain. With this update, the blockchain reorg can only rollback a protocol transactions sequentially from the last step.

The gateway logs each step of a protocol execution in its local database tagged with the hash of the block that included the corresponding transaction. By matching the block-hash subsequence for reversed blocks with the hashes stored in the database, it determines what protocol executions have been affected by the reorg. Now, instead of deleting the the database entries tagged with invalidated block-hashes as in the case of the access control database update, the gateway first tries to update their tags to account for steps whose transactions have been moved to different blocks due to the reorg\footnote{Updating is possible because the document bearer contract emits an event in the blockchain audit log during each step execution.}. The entries that could not be updated even after the gateway has received the most recent block from its peer are then marked as invalid.

Note that the upload and download protocols both have the property that except for the first transaction that the user issues to transfer coins from his/her account to lock them into the document bearer smart contract, all other transactions are cryptographic key based. So anyone else having the keys can re-execute them on behalf of the user. Furthermore, the user's cryptographic keys are all revealed in the blockchain ledgers after the completion of a protocol execution. Hence, the gateway retrieves the user's keys from the blockchain ledger during the protocol execution and stores them with associated step log entries in its database. Then if it is found that a protocol execution trace has not being completely erased due to step rollback, the gateway simply issues the transactions for the missing steps to restore the blockchain trace and collects any associated payment.

If all steps of a protocol execution have been rolled back, this is an irrecoverable situation for the gateway as the gateway can never collect its payment nor can it prove that it has already rendered a service to the user. in case of an upload, the current solution schedules the document to be removed from the storage system after some time. Instant removal is not done because another blockchain reorg may give the gateway a better chance for protocol execution restoration. Nothing could be done in case of a download. Improving the protocols for tackling this scenario is a subject of future research.                                       